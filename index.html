<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbondz Cryptographic Identity and Social Ledger</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        'dir-dark': '#1F2937', // Gray-800
                        'dir-blue': '#10B981', // Emerald-500 for a secure look
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #E5E7EB; }
        .app-container { min-height: 100vh; background-color: #ffffff; }
        .logo-text {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            color: #1F2937;
        }
        .logo-text span {
             color: #10B981;
        }
        .card-bg {
            background: #F9FAFB;
        }
    </style>
</head>
<body>
    <div id="root" class="app-container p-4 md:p-10">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // --- Global State Management ---
        let isAuthenticated = false;
        let currentUser = {
            username: null,
            publicIdentityKey: null,
            name: null,
        };
        let globalDirectory = [];
        let globalComments = [];

        // --- Cryptographic Configuration (Must be consistent) ---
        const PASSWORD_DERIVATION_PARAMS = {
            name: "PBKDF2",
            salt: new TextEncoder().encode("inbondz-salt-v1"), // Fixed salt for deterministic key
            iterations: 100000,
            hash: "SHA-256",
        };
        const ENCRYPTION_PARAMS = { name: "AES-GCM", iv: new TextEncoder().encode("inbondz-iv-v1") }; // Fixed IV for demo
        const ALGORITHM = { name: "AES-GCM", length: 256 };

        // --- Cryptography Utilities ---

        const bufferToBase64 = (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer)));
        const base64ToBuffer = (base64) => Uint8Array.from(atob(base64), c => c.charCodeAt(0)).buffer;

        const deriveMasterKey = async (password) => {
            const passwordBuffer = new TextEncoder().encode(password);
            const baseKey = await window.crypto.subtle.importKey(
                "raw", passwordBuffer, { name: "PBKDF2" }, false, ["deriveKey"]
            );
            return await window.crypto.subtle.deriveKey(
                PASSWORD_DERIVATION_PARAMS, baseKey, ALGORITHM, true, ["encrypt", "decrypt"]
            );
        };

        const generatePublicIdentityKey = async (masterKey) => {
            const keyExport = await window.crypto.subtle.exportKey("raw", masterKey);
            const hashBuffer = await window.crypto.subtle.digest("SHA-256", keyExport);
            return bufferToBase64(hashBuffer).slice(0, 16); // Unique 16-char ID
        };

        const getLocalProfile = () => {
            const storedProfile = localStorage.getItem('inbondz_profile');
            return storedProfile ? JSON.parse(storedProfile) : null;
        };
        
        // --- Data Persistence (Simulated P2P Ledger) ---

        const loadLedgers = () => {
            globalDirectory = JSON.parse(localStorage.getItem('inbondz_directory') || '[]');
            globalComments = JSON.parse(localStorage.getItem('inbondz_comments') || '[]');
        };
        
        const saveDirectory = () => {
            localStorage.setItem('inbondz_directory', JSON.stringify(globalDirectory));
        };

        const saveComments = () => {
            localStorage.setItem('inbondz_comments', JSON.stringify(globalComments));
        };

        // --- Core Application Functions ---

        async function registerIdentity(name, username, password) {
            const cleanUsername = username.trim().toLowerCase();
            
            // 1. Check uniqueness
            if (globalDirectory.some(u => u.username === cleanUsername)) {
                throw new Error(`Username '${cleanUsername}' is already taken.`);
            }

            // 2. Derive Key and Identity
            const masterKey = await deriveMasterKey(password);
            const publicIdentityKey = await generatePublicIdentityKey(masterKey);

            // 3. Encrypt data and store locally
            const plaintext = JSON.stringify({ name: name, username: cleanUsername });
            const plaintextBuffer = new TextEncoder().encode(plaintext);
            const ciphertextBuffer = await window.crypto.subtle.encrypt(ENCRYPTION_PARAMS, masterKey, plaintextBuffer);
            const encryptedData = bufferToBase64(ciphertextBuffer);
            
            localStorage.setItem('inbondz_profile', JSON.stringify({ encryptedData, publicIdentityKey }));

            // 4. Update Global Directory Ledger
            const newDirectoryEntry = { username: cleanUsername, publicIdentityKey, joined: new Date().toISOString() };
            globalDirectory.push(newDirectoryEntry);
            saveDirectory();

            return { username: cleanUsername, publicIdentityKey, name };
        }

        async function authenticateIdentity(password) {
            const localProfile = getLocalProfile();
            if (!localProfile) throw new Error("No local profile found. Please register.");

            const { encryptedData, publicIdentityKey } = localProfile;
            const ciphertextBuffer = base64ToBuffer(encryptedData);

            try {
                const masterKey = await deriveMasterKey(password);
                
                // Attempt decryption (Cryptographic Verification)
                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    ENCRYPTION_PARAMS, masterKey, ciphertextBuffer
                );

                const plaintext = new TextDecoder().decode(decryptedBuffer);
                const verifiedUserData = JSON.parse(plaintext);
                
                // Set the current authenticated user's details
                currentUser = { 
                    ...verifiedUserData,
                    publicIdentityKey: publicIdentityKey 
                };
                
                isAuthenticated = true;
                return verifiedUserData;

            } catch (e) {
                console.error("Decryption failed:", e);
                throw new Error("Invalid password (Key mismatch).");
            }
        }

        function createComment(text) {
            if (!isAuthenticated || !currentUser.username) {
                throw new Error("Must be logged in to comment.");
            }
            
            const newComment = {
                id: crypto.randomUUID(),
                username: currentUser.username,
                publicIdentityKey: currentUser.publicIdentityKey,
                text: text.trim(),
                timestamp: new Date().toISOString(),
            };
            
            globalComments.unshift(newComment); // Add to the top
            saveComments();
            renderCommentsSection(); // Re-render comments immediately
        }

        function deleteComment(commentId) {
            const index = globalComments.findIndex(c => c.id === commentId && c.publicIdentityKey === currentUser.publicIdentityKey);

            if (index > -1) {
                globalComments.splice(index, 1);
                saveComments();
                renderCommentsSection(); // Re-render comments immediately
            } else {
                console.error("Comment not found or unauthorized deletion attempt.");
            }
        }

        function logout() {
            isAuthenticated = false;
            currentUser = { username: null, publicIdentityKey: null, name: null };
            renderApp();
        }

        // --- HTML Rendering Functions ---

        const getHeader = () => `
            <header class="mb-10 text-center">
                <h1 class="logo-text flex justify-center items-center">
                    <i class="fas fa-fingerprint text-dir-blue mr-3 text-4xl"></i>
                    accounts.<span>inbondz.com</span>
                </h1>
                <p class="text-gray-500 mt-1 text-lg">Self-Authenticating Decentralized Identity & Social Ledger</p>
            </header>
        `;

        const getErrorMessage = (message) => `
            <p class="text-red-600 bg-red-100 p-3 rounded-lg text-sm mb-4">${message}</p>
        `;

        const renderRegistrationView = (error = null) => {
            const html = `
                ${getHeader()}
                <div class="w-full max-w-lg mx-auto p-8 bg-white shadow-2xl rounded-2xl">
                    <h2 class="text-3xl font-bold text-dir-dark border-b pb-4 mb-6 flex items-center">
                        <i class="fas fa-key mr-3 text-dir-blue"></i> Register Unique Identity
                    </h2>
                    ${error ? getErrorMessage(error) : ''}
                    <form id="registration-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="reg-name" class="w-full p-3 border border-gray-300 rounded-lg focus:border-dir-blue focus:ring-1 focus:ring-dir-blue" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unique Username (P2P ID)</label>
                            <input type="text" id="reg-username" class="w-full p-3 border border-gray-300 rounded-lg focus:border-dir-blue focus:ring-1 focus:ring-dir-blue lowercase" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password (Cryptographic Key)</label>
                            <input type="password" id="reg-password" class="w-full p-3 border border-gray-300 rounded-lg focus:border-dir-blue focus:ring-1 focus:ring-dir-blue" required />
                        </div>
                        <button type="submit" id="reg-button" class="w-full bg-dir-blue text-white p-3 rounded-lg font-semibold hover:bg-dir-blue/90 transition disabled:bg-gray-400 flex items-center justify-center">
                            <i class="fas fa-user-plus mr-2"></i> Register & Encrypt
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('root').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen">
                    ${html}
                </div>
            `;
            
            // Attach event listener
            document.getElementById('registration-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('reg-name').value;
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                const button = document.getElementById('reg-button');
                
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating Keys...';

                try {
                    await registerIdentity(name, username, password);
                    renderApp(); // Rerender to the authenticated state or login view
                } catch (err) {
                    renderRegistrationView(err.message);
                }
            });
        };

        const renderLoginView = (error = null) => {
            const html = `
                ${getHeader()}
                <div class="w-full max-w-lg mx-auto p-8 bg-white shadow-2xl rounded-2xl">
                    <h2 class="text-3xl font-bold text-dir-dark border-b pb-4 mb-6 flex items-center">
                        <i class="fas fa-shield-halved mr-3 text-dir-blue"></i> Cryptographic Login
                    </h2>
                    ${error ? getErrorMessage(error) : ''}
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:border-dir-blue focus:ring-1 focus:ring-dir-blue" required />
                        </div>
                        <button type="submit" id="login-button" class="w-full bg-dir-blue text-white p-3 rounded-lg font-semibold hover:bg-dir-blue/90 transition disabled:bg-gray-400 flex items-center justify-center">
                            <i class="fas fa-sign-in-alt mr-2"></i> Login (Verify Key)
                        </button>
                    </form>
                    <div class="text-center mt-6 pt-4 border-t">
                        <p class="text-sm text-gray-500">Need to start fresh? Your current profile is stored locally. Clear browser storage to re-register.</p>
                    </div>
                </div>
            `;
            document.getElementById('root').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen">
                    ${html}
                </div>
            `;
            
            // Attach event listener
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = document.getElementById('login-password').value;
                const button = document.getElementById('login-button');
                
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Verifying Keys...';

                try {
                    await authenticateIdentity(password);
                    renderApp();
                } catch (err) {
                    renderLoginView(err.message);
                }
            });
        };

        const renderDirectorySection = () => {
            const directoryHtml = globalDirectory.map(user => `
                <div class="p-4 card-bg rounded-lg shadow-md border-l-4 border-dir-blue/50">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-dir-dark flex items-center">
                            <i class="fas fa-satellite-dish mr-2 text-dir-blue"></i>
                            ${user.username}
                            ${user.publicIdentityKey === currentUser.publicIdentityKey ? '<span class="ml-3 text-xs bg-dir-blue text-white px-2 py-0.5 rounded-full">YOU</span>' : ''}
                        </h3>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 truncate">
                        Public Key: <span class="font-mono">${user.publicIdentityKey}</span>
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        Joined: ${new Date(user.joined).toLocaleDateString()}
                    </p>
                </div>
            `).join('');

            return `
                <div class="p-8 bg-white shadow-2xl rounded-2xl w-full">
                    <h2 class="text-3xl font-bold text-dir-dark border-b pb-4 mb-6 flex items-center">
                        <i class="fas fa-network-wired mr-3 text-dir-blue"></i> Global P2P Directory
                    </h2>
                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        ${directoryHtml || '<p class="text-center py-10 text-gray-500 bg-gray-100 rounded-lg">No identities registered yet.</p>'}
                    </div>
                </div>
            `;
        };

        const renderCommentCard = (comment) => {
            const isOwner = comment.publicIdentityKey === currentUser.publicIdentityKey;
            
            return `
                <div class="p-4 border-b border-gray-200 hover:bg-gray-50 transition duration-150">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center mb-1">
                            <span class="text-lg font-bold text-dir-dark mr-2">${comment.username}</span>
                            ${isOwner ? '<span class="text-xs bg-dir-blue text-white px-2 py-0.5 rounded-full">YOU</span>' : ''}
                            <span class="text-xs text-gray-400 ml-3">
                                ${new Date(comment.timestamp).toLocaleDateString()}
                            </span>
                        </div>
                        ${isOwner ? `
                            <button onclick="deleteComment('${comment.id}')" 
                                class="text-red-500 hover:text-red-700 transition p-1 rounded-full hover:bg-red-100">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        ` : ''}
                    </div>
                    <p class="text-gray-700">${comment.text}</p>
                </div>
            `;
        };

        const renderCommentsSection = () => {
            const commentContainer = document.getElementById('comments-list');
            if (!commentContainer) return;

            const commentsHtml = globalComments.map(renderCommentCard).join('');
            commentContainer.innerHTML = commentsHtml;
        };
        
        const renderAuthenticatedView = () => {
            document.getElementById('root').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen pt-10 pb-10">
                    ${getHeader()}
                    <main class="w-full max-w-6xl space-y-8">
                        
                        <div class="p-4 bg-green-100 text-green-800 rounded-xl text-center shadow-md border-t-4 border-dir-blue flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold">Authenticated as @${currentUser.username} (${currentUser.name})</h3>
                                <p class="text-sm text-green-700">Verification successful via cryptographic key.</p>
                            </div>
                            <button onclick="logout()" class="bg-red-500 text-white p-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Global Directory Panel -->
                            <div class="order-2 lg:order-1">
                                ${renderDirectorySection()}
                            </div>
                            
                            <!-- Comments/Social Ledger Panel -->
                            <div class="p-8 bg-white shadow-2xl rounded-2xl w-full order-1 lg:order-2">
                                <h2 class="text-3xl font-bold text-dir-dark border-b pb-4 mb-6 flex items-center">
                                    <i class="fas fa-comment-dots mr-3 text-dir-blue"></i> Social Ledger
                                </h2>

                                <!-- Comment Form -->
                                <form id="comment-form" class="mb-6 pb-6 border-b border-gray-200">
                                    <textarea id="comment-text" class="w-full p-3 border border-gray-300 rounded-lg focus:border-dir-blue focus:ring-1 focus:ring-dir-blue" rows="3" placeholder="Post a comment to the public ledger..." required></textarea>
                                    <button type="submit" class="w-full bg-dir-dark text-white p-3 rounded-lg font-semibold hover:bg-dir-dark/90 transition disabled:bg-gray-400 mt-2">
                                        <i class="fas fa-paper-plane mr-2"></i> Publish Comment
                                    </button>
                                </form>

                                <!-- Comments List Container -->
                                <div id="comments-list" class="space-y-2 max-h-[500px] overflow-y-auto">
                                    <!-- Comments will be injected here by renderCommentsSection() -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer Status -->
                        <footer class="text-center pt-10 text-gray-500">
                            <p class="text-xs">
                                All data (profiles and comments) are stored in the client's browser (simulating a local node). Authentication is Zero-Knowledge.<br/>
                                The public ledger is updated in real-time within your browser's local storage.
                            </p>
                        </footer>

                    </main>
                </div>
            `;
            
            // Attach event listeners for comments
            document.getElementById('comment-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const text = document.getElementById('comment-text').value;
                if (text.trim()) {
                    createComment(text);
                    document.getElementById('comment-text').value = ''; // Clear input
                }
            });

            // Initial render of comments
            renderCommentsSection();
        };

        const renderApp = () => {
            loadLedgers(); // Always reload data from storage first
            const localProfile = getLocalProfile();

            if (isAuthenticated) {
                renderAuthenticatedView();
            } else if (localProfile) {
                renderLoginView();
            } else {
                renderRegistrationView();
            }
        };

        // Initialize application on load
        window.onload = renderApp;
    </script>
</body>
</html>



























