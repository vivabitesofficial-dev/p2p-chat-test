<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2EE P2P Decentralized Chat</title>
    <!-- Load GUN and SEA for decentralized data and security -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the WhatsApp-like aesthetic and scrollbar */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* The background pattern for the chat area */
        #chat-window {
            background-color: #e5ddd5; /* Light WhatsApp background */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23ccc' fill-opacity='0.2'%3E%3Cpath fill-rule='evenodd' d='M0 0h40v40H0V0zm40 40h40v40H40V40z'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #059669; border-radius: 3px; }
        #chat-window::-webkit-scrollbar-track { background: #e5ddd5; }

        .chat-container { height: 100vh; }
        @media (min-width: 768px) {
            .chat-container { height: 95vh; }
        }

        /* Ensure smooth transition between sidebar and chat view on mobile */
        #contact-sidebar, #chat-panel {
            min-width: 100%;
        }
        @media (min-width: 768px) {
             #contact-sidebar { min-width: 300px; width: 33.333333%; }
             #chat-panel { min-width: 66.666667%; }
        }
    </style>
</head>
<body class="bg-gray-100 p-0 md:p-6 flex justify-center items-center">

    <!-- Main Chat Window Container -->
    <div class="w-full chat-container max-w-5xl bg-white shadow-2xl rounded-xl flex overflow-hidden">
        
        <!-- Sidebar: Contact List -->
        <div id="contact-sidebar" class="w-full md:w-1/3 border-r border-gray-200 flex flex-col flex-shrink-0 transition-all">
            
            <!-- Sidebar Header (User Profile/Settings) -->
            <header class="p-4 bg-[#075E54] text-white flex justify-between items-center shadow-md">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide-message-circle"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8-3.8L21 3z"/></svg>
                    <h1 class="text-xl font-bold">Inbondz P2P</h1>
                </div>
                <!-- Three Dots for Menu (Settings) -->
                <button onclick="showSettingsModal()" class="text-white hover:text-gray-200 transition p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide-more-vertical"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
            </header>

            <!-- Contact Search/Add -->
            <div class="p-3 border-b border-gray-200 bg-gray-50">
                <input id="addContactInput" type="text" placeholder="Paste P2P ID here to add new contact"
                       class="w-full p-2 border border-gray-300 rounded focus:ring-emerald-500 focus:border-emerald-500">
                <button onclick="addContact()" class="mt-2 w-full bg-emerald-500 text-white p-2 rounded-lg hover:bg-emerald-600 transition">
                    Add New Contact
                </button>
            </div>

            <!-- Contacts List -->
            <div id="contacts-list" class="flex-grow overflow-y-auto">
                <div id="initial-contact-message" class="p-4 text-center text-sm text-gray-500">
                    Contacts will appear here. Add a friend's Public ID from the settings menu to chat!
                </div>
            </div>
            
        </div>

        <!-- Main Chat Panel -->
        <div class="w-full flex-grow flex flex-col hidden" id="chat-panel">
            
            <!-- Chat Header -->
            <header class="p-4 bg-gray-100 text-gray-800 flex justify-between items-center border-b shadow-sm">
                <button onclick="P2PChat.backToContacts()" class="md:hidden p-1 mr-2 text-gray-600 hover:text-gray-900 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                </button>
                <h2 id="chat-header-name" class="text-xl font-semibold flex-grow">Select a Contact</h2>
            </header>

            <!-- Messages Area -->
            <div class="flex-grow p-4 overflow-y-auto flex flex-col-reverse" id="chat-window">
                <div id="messages-list" class="flex flex-col space-y-3">
                    <!-- Messages will be injected here -->
                    <div id="initial-message" class="text-center text-gray-600 p-10">
                        <p>Select a contact to start an End-to-End Encrypted chat.</p>
                        <p>Chat data is stored securely on the P2P network (GUN).</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-300 bg-gray-50">
                <div class="flex space-x-2">
                    <input 
                        id="message-input" 
                        placeholder="Type your encrypted message..." 
                        onkeydown="if(event.key === 'Enter') P2PChat.sendMessage()"
                        class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-[#075E54] focus:border-[#075E54] shadow-inner"
                        disabled
                    >
                    <button onclick="P2PChat.sendMessage()" id="send-button"
                        class="bg-[#075E54] text-white p-3 rounded-full shadow-lg hover:bg-[#128C7E] transition disabled:bg-gray-400"
                        disabled
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide-send"><path d="m22 2-7 15-2 2-2 2-7-15Z"/><path d="M22 2 11 13"/><path d="m11 13 6 6"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals (Settings and Prompt) -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg space-y-4">
            <h2 class="text-xl font-bold text-[#075E54]">User Settings & ID</h2>
            
            <div>
                <label for="displayNameInput" class="text-sm font-medium text-gray-700 block mb-1">Your Display Name</label>
                <input id="displayNameInput" class="w-full p-2 border border-gray-300 rounded focus:ring-emerald-500 focus:border-emerald-500">
            </div>

            <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Your Unique P2P ID (Public Key)</label>
                <textarea id="publicIdDisplay" readonly 
                          class="w-full p-2 border border-gray-300 rounded bg-gray-100 font-mono text-xs h-24 resize-none"></textarea>
                <button onclick="copyPublicId()" class="mt-2 text-xs text-blue-500 hover:text-blue-700">
                    Click to Copy Public ID
                </button>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="saveSettings()" class="px-4 py-2 rounded bg-[#128C7E] text-white hover:bg-[#075E54] transition">Save & Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Dialog/Alert -->
    <div id="dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm space-y-4">
            <p id="dialogMessage" class="text-gray-800"></p>
            <div class="flex justify-end">
                <button onclick="closeDialog()" class="px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global Constants and Initialization ---
        const GUN_PEERS = ['https://gun-manhattan.herokuapp.com/gun'];
        const gun = Gun(GUN_PEERS);
        
        const DISPLAY_NAME_KEY = 'inbondz_chat_name';
        const PAIR_KEY = 'inbondz_p2p_pair';

        let userPair = null;
        let userName = '';
        let currentRecipientPub = null;
        const contacts = {}; // {pubKey: {name: '...', pub: '...'}}
        const listeners = {}; // Store listeners for cleanup

        // --- Utility Functions ---

        /** Generates a unique, shared path for an E2EE chat thread. */
        async function getChatPath(pub1, pub2) {
            // Sort keys to ensure the path is the same regardless of who initiates the chat
            const sortedKeys = [pub1, pub2].sort();
            // Use a stable hash of the keys for the path name
            const path = await SEA.work(sortedKeys.join(''), null, null, { name: 'SHA-256' });
            return `~${sortedKeys[0]}/${sortedKeys[1]}/${path.slice(0, 16)}`;
        }

        /** Simple utility for creating consistent colors from user names. */
        function stringToHslColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return `hsl(${h}, 50%, 40%)`;
        }

        /** Shows a custom dialog (replacing alert/confirm). */
        function showDialog(message) {
            document.getElementById('dialogMessage').textContent = message;
            document.getElementById('dialog').classList.remove('hidden');
        }

        function closeDialog() {
            document.getElementById('dialog').classList.add('hidden');
        }

        // --- User Identity and Settings ---

        async function getOrCreateUserIdentity() {
            const savedPair = localStorage.getItem(PAIR_KEY);
            
            if (savedPair) {
                userPair = JSON.parse(savedPair);
                userName = localStorage.getItem(DISPLAY_NAME_KEY) || `User-${userPair.pub.substring(0, 4)}`;
            } else {
                userPair = await SEA.pair();
                localStorage.setItem(PAIR_KEY, JSON.stringify(userPair));
                
                userName = `User-${userPair.pub.substring(0, 4)}_${Math.floor(Math.random() * 999)}`;
                localStorage.setItem(DISPLAY_NAME_KEY, userName);
                showSettingsModal(); 
            }
            
            updateSettingsUI();
            P2PChat.init();
        }
        
        function updateSettingsUI() {
            document.getElementById('displayNameInput').value = userName;
            document.getElementById('publicIdDisplay').value = userPair ? userPair.pub : 'Loading...';
            document.getElementById('message-input').disabled = !userPair;
            document.getElementById('send-button').disabled = !userPair || !currentRecipientPub;
            
            // Update sidebar header with user's name
            document.querySelector('#contact-sidebar header h1').textContent = userName;
        }

        function saveSettings() {
            const newName = document.getElementById('displayNameInput').value.trim();
            if (newName && newName !== userName) {
                userName = newName;
                localStorage.setItem(DISPLAY_NAME_KEY, userName);
                P2PChat.loadContacts(); 
            }
            document.getElementById('settingsModal').classList.add('hidden');
            updateSettingsUI();
        }

        function showSettingsModal() {
            updateSettingsUI();
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        
        function copyPublicId() {
            // Check if userPair is available before copying
            if (!userPair) {
                showDialog("Identity not yet loaded. Please wait a moment.");
                return;
            }
            // Use execCommand('copy') as navigator.clipboard.writeText() often fails in iframes.
            const textarea = document.getElementById('publicIdDisplay');
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showDialog("Your Public ID has been copied to the clipboard. Share it with a contact!");
                } else {
                    throw new Error("ExecCommand failed.");
                }
            } catch (err) {
                showDialog("Failed to copy ID. Please copy manually from the box.");
                console.error('Copy error:', err);
            }
        }
        
        function addContact() {
            const input = document.getElementById('addContactInput');
            const newPub = input.value.trim();
            input.value = '';

            // Basic validation
            if (!newPub || newPub.length < 50) {
                showDialog("Invalid Public ID format. It must be the full, long key.");
                return;
            }
            if (newPub === userPair.pub) {
                showDialog("You cannot add yourself as a contact.");
                return;
            }
            if (contacts[newPub]) {
                 showDialog(`Contact with ID ${newPub.substring(0, 10)}... is already saved.`);
                 return;
            }
            
            // Store contact privately on the user's data space
            const contactRef = gun.user(userPair.pub).get('contacts').get(newPub);
            contactRef.put({ name: `Unknown-${newPub.substring(newPub.length - 4)}`, pub: newPub });
            
            showDialog(`Contact ID ending in ${newPub.substring(newPub.length - 4)} saved successfully!`);
        }

        // --- P2P Chat Logic (Class for Organization) ---
        const P2PChat = {
            init: function() {
                this.loadContacts();
                // Show chat panel on desktop by default
                if (window.innerWidth >= 768) {
                    document.getElementById('chat-panel').classList.remove('hidden');
                }
            },

            backToContacts: function() {
                // For mobile only: hide chat panel and show contact list
                document.getElementById('chat-panel').classList.add('hidden');
                document.getElementById('contact-sidebar').classList.remove('hidden');
            },

            loadContacts: function() {
                const list = document.getElementById('contacts-list');
                document.getElementById('initial-contact-message').classList.remove('hidden');

                // Clear listeners first
                const contactsRef = gun.user(userPair.pub).get('contacts');
                if (listeners['contacts']) {
                    listeners['contacts'].off();
                }

                // Listen for changes to the user's private 'contacts' list
                listeners['contacts'] = contactsRef.map().on((data, pubKey) => {
                    if (data && data.pub) {
                        document.getElementById('initial-contact-message').classList.add('hidden');
                        contacts[pubKey] = { ...data, pub: pubKey };
                        this.renderContact(contacts[pubKey]);
                    }
                });
            },

            renderContact: function(contact) {
                const list = document.getElementById('contacts-list');
                let contactEl = document.getElementById(`contact-${contact.pub}`);

                const isActive = contact.pub === currentRecipientPub;

                if (!contactEl) {
                    contactEl = document.createElement('div');
                    contactEl.id = `contact-${contact.pub}`;
                    // Important: Bind the selection function here
                    contactEl.onclick = () => this.selectChat(contact.pub);
                    list.appendChild(contactEl);
                }

                // Update contact content and highlight
                contactEl.className = `flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b ${isActive ? 'bg-emerald-100 border-l-4 border-emerald-500' : 'bg-white'}`;
                
                contactEl.innerHTML = `
                    <div class="rounded-full w-10 h-10 flex items-center justify-center font-bold text-white text-lg mr-3 flex-shrink-0" 
                         style="background-color: ${stringToHslColor(contact.name)}">
                        ${contact.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${contact.name}</p>
                        <p class="text-xs text-gray-500 truncate">ID: ${contact.pub.substring(0, 10)}...</p>
                    </div>
                `;
            },
            
            selectChat: async function(recipientPub) {
                // Mobile view switch
                if (window.innerWidth < 768) {
                    document.getElementById('contact-sidebar').classList.add('hidden');
                    document.getElementById('chat-panel').classList.remove('hidden');
                }
                
                // 1. Cleanup old listener
                if (currentRecipientPub && listeners[currentRecipientPub]) {
                    listeners[currentRecipientPub].off();
                    delete listeners[currentRecipientPub];
                }

                currentRecipientPub = recipientPub;
                document.getElementById('chat-header-name').textContent = contacts[recipientPub].name;
                
                // Re-enable input fields
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                
                // Re-render all contacts to highlight the active one
                Object.values(contacts).forEach(this.renderContact.bind(this));

                // 2. Clear messages and start listening for the new chat path
                document.getElementById('messages-list').innerHTML = '';
                document.getElementById('initial-message').classList.add('hidden');


                const chatPath = await getChatPath(userPair.pub, recipientPub);
                const chatRef = gun.get(chatPath);
                
                // Set up the new listener
                listeners[recipientPub] = chatRef.map().on(async (encryptedData, msgKey) => {
                    // Check if the data is a valid encrypted object and not flagged for deletion
                    if (!encryptedData || !encryptedData.ct) return; 

                    try {
                        // Decrypt the data using the shared secret
                        const message = await SEA.decrypt(encryptedData, userPair);
                        
                        // Check if the decrypted message exists and hasn't been flagged for soft delete
                        if (message && message.text && !message.deleted) {
                            this.renderMessage({ ...message, msgKey, encryptedData });
                        } else if (message && message.deleted) {
                            // If the message is flagged for delete, ensure it's removed from the UI
                            const element = document.getElementById(`msg-${msgKey}`);
                            if (element) element.remove();
                        }
                    } catch (e) {
                        // This indicates a decryption failure (e.g., corrupt data, wrong key combination)
                        console.warn("Could not decrypt message for key:", msgKey, e);
                    }
                }, {change: true}); 
            },

            sendMessage: async function() {
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                if (!text || !currentRecipientPub) return;

                input.value = '';

                // 1. Prepare data
                const messageData = {
                    text: text,
                    sender: userName,
                    pub: userPair.pub,
                    timestamp: Date.now()
                };

                // 2. Encrypt the data
                // The encryption key is derived from the concatenation of the sender's and receiver's public keys.
                // SEA handles the E2EE key exchange automatically here.
                const encrypted = await SEA.encrypt(messageData, userPair.pub + currentRecipientPub);

                if (!encrypted) {
                    showDialog("Encryption failed. Cannot send message.");
                    return;
                }

                // 3. Store on the shared decentralized path
                const chatPath = await getChatPath(userPair.pub, currentRecipientPub);
                const chatRef = gun.get(chatPath);
                
                // Store using the timestamp as the key
                chatRef.get(String(messageData.timestamp)).put(encrypted);
            },

            renderMessage: function(message) {
                const list = document.getElementById('messages-list');
                let messageEl = document.getElementById(`msg-${message.msgKey}`);

                if (messageEl) return; // Already rendered or being rendered

                const isSelf = message.pub === userPair.pub;
                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' });

                // Base WhatsApp bubble styling
                const baseClass = "p-2.5 rounded-xl shadow-md max-w-[80%] relative group transition-all";
                const selfClass = "bg-[#dcf8c6] ml-auto rounded-br-md"; 
                const otherClass = "bg-white mr-auto rounded-tl-md";

                messageEl = document.createElement('div');
                messageEl.id = `msg-${message.msgKey}`;
                messageEl.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = `${baseClass} ${isSelf ? selfClass : otherClass} flex flex-col`;
                
                // Add Name (if not self)
                if (!isSelf) {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = "text-xs font-bold mb-1 -mt-0.5";
                    nameSpan.textContent = message.sender;
                    nameSpan.style.color = stringToHslColor(message.sender);
                    bubble.appendChild(nameSpan);
                }

                // Add Text
                const textP = document.createElement('p');
                textP.className = "text-sm text-gray-800";
                textP.textContent = message.text;
                bubble.appendChild(textP);

                // Add Footer (Time and Status)
                const footerDiv = document.createElement('div');
                footerDiv.className = "flex justify-end items-center mt-1 space-x-1";
                
                const timeSpan = document.createElement('span');
                timeSpan.className = `text-[10px] opacity-70 ${isSelf ? 'text-gray-600' : 'text-gray-500'}`;
                timeSpan.textContent = time;
                footerDiv.appendChild(timeSpan);
                
                if (isSelf) {
                    // Checkmark SVG for sent status (Delivered/Seen in a real app)
                    const check = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    check.setAttribute("width", "12"); check.setAttribute("height", "12");
                    check.setAttribute("viewBox", "0 0 24 24"); check.setAttribute("fill", "none");
                    check.setAttribute("stroke", "currentColor"); check.setAttribute("stroke-width", "3");
                    check.setAttribute("stroke-linecap", "round"); check.setAttribute("stroke-linejoin", "round");
                    check.className = "text-[#128C7E]"; 
                    check.innerHTML = '<path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L12 15"/>';
                    footerDiv.appendChild(check);
                }

                bubble.appendChild(footerDiv);
                messageEl.appendChild(bubble);

                // Add delete button (Only for self messages)
                if (isSelf) {
                     const deleteButton = document.createElement('button');
                     deleteButton.title = "Delete for everyone (soft delete)";
                     // Position the delete button to appear on hover
                     deleteButton.className = 'absolute -top-1 -right-1 text-red-500 opacity-0 group-hover:opacity-100 transition p-1 rounded-full bg-white shadow-lg z-10';
                     deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`;
                     deleteButton.onclick = () => this.deleteMessage(message.msgKey, message.encryptedData);
                     bubble.appendChild(deleteButton);
                }


                list.prepend(messageEl); 
                // Ensure scroll to bottom
                const container = document.getElementById('chat-window');
                container.scrollTop = container.scrollHeight;
            },

            deleteMessage: async function(msgKey, encryptedData) {
                // Use the custom dialog instead of confirm
                const confirmDelete = window.confirm("Are you sure you want to delete this message for everyone? (Soft Delete)");
                if (!confirmDelete) return;

                try {
                    // 1. Decrypt to get the original object
                    const message = await SEA.decrypt(encryptedData, userPair);
                    if (!message) throw new Error("Decryption failed for delete.");

                    // 2. Add the 'deleted' flag
                    message.deleted = true;
                    
                    // 3. Re-encrypt the message with the 'deleted' flag
                    const reEncrypted = await SEA.encrypt(message, userPair.pub + currentRecipientPub);

                    // 4. Update the node on the GUN graph (soft delete)
                    const chatPath = await getChatPath(userPair.pub, currentRecipientPub);
                    const chatRef = gun.get(chatPath);
                    chatRef.get(msgKey).put(reEncrypted);

                    // 5. Remove from UI immediately
                    const element = document.getElementById(`msg-${msgKey}`);
                    if (element) element.remove();

                    // NOTE: The map().on listener will automatically remove the message for the recipient
                    // when they receive the update with the 'deleted: true' flag.

                } catch (e) {
                    showDialog("Failed to soft-delete message. Error: " + e.message);
                    console.error('Delete error:', e);
                }
            }
        };

        // --- Startup ---
        window.onload = async () => {
            // Check for desktop vs mobile initially
            if (window.innerWidth >= 768) {
                document.getElementById('chat-panel').classList.remove('hidden');
            } else {
                // Mobile starts on contact list
                document.getElementById('contact-sidebar').classList.remove('hidden');
            }
            await getOrCreateUserIdentity();
        };

    </script>
</body>
</html>







